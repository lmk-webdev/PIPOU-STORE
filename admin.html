<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - PIPOU Store</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    header {
      background: #111;
      color: white;
      padding: 30px;
      text-align: center;
      font-size: 1.5em;
    }
    #welcome {
      text-align: center;
      padding: 60px 20px;
      font-size: 1.8em;
      color: #444;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .controls button {
      padding: 12px 20px;
      background: #222;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .controls button:hover {
      background: #444;
    }
    section {
      display: none;
      max-width: 800px;
      margin: auto;
    }
    section.active {
      display: block;
    }
    form, .article {
      background: white;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    form input, form select, form textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    form button {
      background: #111;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
    }
    .description-ia {
      text-align: left;
      font-size: 0.9em;
      color: #666;
      margin-bottom: 8px;
    }
    .description-ia button {
      background: #ffc107;
      color: #111;
      padding: 5px 10px;
      font-size: 0.9em;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .taille-bouton {
      display: inline-block;
      margin: 6px;
      padding: 10px 16px;
      background: #eee;
      border-radius: 20px;
      cursor: pointer;
      border: 1px solid #ccc;
      user-select: none;
      font-weight: bold;
      transition: all 0.2s ease-in-out;
    }
    .taille-bouton:hover {
      background: #ddd;
    }
    .taille-bouton input {
      display: none;
    }
    .taille-bouton input:checked + span {
      background-color: #222;
      color: white;
      border-radius: 20px;
      padding: 10px 16px;
      display: inline-block;
    }

    #openSidebarBtn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 12px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 1000;
    }
    #sidebar {
      position: fixed;
      left: -300px;
      top: 0;
      width: 300px;
      height: 100%;
      background: #f9f9f9;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      padding: 20px;
      transition: left 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }
    #sidebar.active {
      left: 0;
    }
    #logout-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: crimson;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 1000;
    }

    #liste-articles {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: flex-start;
    }
    .article {
      flex: 1 1 250px;
      max-width: 250px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .article img {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .article button {
      margin: 5px 5px 0 0;
      background: #111;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      flex-grow: 0;
    }
    .article-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }
  </style>
</head>
<body>

<header>Bienvenue sur l‚Äôadministration de PIPOU-Store</header>
<div id="welcome">Bienvenue ! Choisis une action ci-dessous üëá</div>

<div class="controls">
  <button id="btn-ajout">‚ûï Ajouter un article</button>
  <button id="btn-liste">üì¶ Voir les articles</button>
</div>

<section id="section-ajout">
  <form id="article-form">
    <h2 id="form-title">Ajouter un article</h2>
    <input type="text" id="nom" placeholder="Nom du produit" required />
    <input type="number" id="prix" placeholder="Prix (‚Ç¨)" step="0.01" required />
    <div class="description-ia">
      <button type="button" id="btn-description">‚ú® G√©n√©rer une description automatique (d√©taill√©e)</button>
    </div>
    <textarea id="description" placeholder="Description"></textarea>
    <input type="file" id="image" accept="image/*" />
    <select id="categorie" required>
      <option value="">-- S√©lectionner une cat√©gorie --</option>
      <option value="sacoches">sacoches</option>
      <option value="ceintures">ceintures</option>
      <option value="couvre-chef">couvre-chef</option>
      <option value="porte-feuille">porte-feuille</option>
      <option value="t-shirts">t-shirts</option>
      <option value="maillots">maillots</option>
      <option value="chemise">chemise</option>
      <option value="vestes/manteaux">vestes/manteaux</option>
      <option value="pantalon">pantalon</option>
      <option value="short">short</option>
      <option value="ensembles">ensembles</option>
      <option value="basket">basket</option>
      <option value="sabots">sabots</option>
      <option value="sneackers">sneackers</option>
      <option value="divers">divers</option>
      <option value="sweat">sweat</option>
      <option value="sweat-√†-capuche">sweat √† capuche</option>
      <option value="pull">pull</option>
    </select>
    <div id="tailles-container" style="display:none;">
      <label><strong>Tailles disponibles :</strong></label>
      <div id="tailles-options"></div>
    </div>
    <button type="submit" id="submit-btn">Ajouter</button>
  </form>
</section>

<section id="section-liste">
  <h2>Articles enregistr√©s</h2>
  <div id="liste-articles"></div>
</section>

<button id="openSidebarBtn">üé® Fond</button>
<div id="sidebar">
  <h3>Changer le fond</h3>
  <button id="fond-blanc">Blanc</button>
  <button id="fond-noir">Noir</button>
  <button id="fond-gris">Gris clair</button>
  <hr>
  <p><strong>Image personnalis√©e :</strong></p>
  <input type="file" id="fond-file" accept="image/*" />
  <button id="upload-fond">Envoyer l'image</button>
</div>
<button id="logout-btn">D√©connexion</button>

<script>
// Session check
fetch('/check-session', { credentials: 'include' })
  .then(res => {
    if (!res.ok) window.location.href = '/login.html';
  });

const toutesTaillesChaussures = [38, 39, 40, 41, 42, 43, 44, 45];
const toutesTaillesVetements = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];

const form = document.getElementById('article-form');
const taillesContainer = document.getElementById('tailles-container');
const taillesOptions = document.getElementById('tailles-options');
const categorieSelect = document.getElementById('categorie');
const liste = document.getElementById('liste-articles');
let editingIndex = null;
let articles = [];

function toggleSection(id) {
  document.getElementById('section-ajout').classList.remove('active');
  document.getElementById('section-liste').classList.remove('active');
  document.getElementById('welcome').style.display = 'none';
  document.getElementById(`section-${id}`).classList.add('active');
}

function afficherTaillesSiBesoin() {
  const cat = categorieSelect.value;
  let tailles = [];

  if (['sneackers', 'basket', 'sabots'].includes(cat)) {
    tailles = toutesTaillesChaussures;
  } else if (['t-shirts', 'maillots', 'vestes/manteaux', 'pantalon', 'short'].includes(cat)) {
    tailles = toutesTaillesVetements;
  }

  if (tailles.length) {
    taillesContainer.style.display = "block";
    taillesOptions.innerHTML = tailles.map(t => `
      <label class="taille-bouton">
        <input type="checkbox" value="${t}"> <span>${t}</span>
      </label>
    `).join('');
  } else {
    taillesContainer.style.display = "none";
    taillesOptions.innerHTML = '';
  }
}

categorieSelect.addEventListener('change', afficherTaillesSiBesoin);

function afficherArticles() {
  fetch('/articles.json', { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      articles = data;
      liste.innerHTML = '';

      // On affiche en ordre inverse (dernier ajout√© en premier)
      articles.slice().reverse().forEach((a, i) => {
        const articleIndex = articles.length - 1 - i;
        const div = document.createElement('div');
        div.classList.add('article');
        div.innerHTML = `
          <h3>${a.nom}</h3>
          <p><strong>Prix :</strong> ${a.prix} ‚Ç¨</p>
          <p><strong>Description :</strong> ${a.description}</p>
          ${a.image ? `<img src="${a.image}" alt="${a.nom}">` : ''}
          <p><strong>Cat√©gorie :</strong> ${a.categorie}</p>
          <p><strong>Tailles :</strong> ${a.tailles ? a.tailles.join(', ') : 'Aucune'}</p>
          <div class="article-buttons">
            <button class="modifier-btn" data-index="${articleIndex}">‚úèÔ∏è Modifier</button>
            <button class="supprimer-btn" data-index="${articleIndex}">‚ùå Supprimer</button>
          </div>
        `;
        liste.appendChild(div);
      });

      // Ajout des event listeners pour les boutons modifier et supprimer
      document.querySelectorAll('.modifier-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          const idx = +e.currentTarget.dataset.index;
          modifierArticle(idx);
        });
      });
      document.querySelectorAll('.supprimer-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          const idx = +e.currentTarget.dataset.index;
          supprimerArticle(idx);
        });
      });
    });
}

function modifierArticle(index) {
  editingIndex = index;
  const a = articles[index];
  toggleSection('ajout');
  document.getElementById('form-title').textContent = 'Modifier un article';
  form.nom.value = a.nom || '';
  form.prix.value = a.prix || '';
  form.description.value = a.description || '';
  form.categorie.value = a.categorie || '';
  afficherTaillesSiBesoin();

  // On coche les tailles
  const inputs = taillesOptions.querySelectorAll('input[type=checkbox]');
  inputs.forEach(i => {
    i.checked = a.tailles && a.tailles.includes(i.value);
  });

  // Image n'est pas modifiable ici (√† simplifier si besoin)
}

function supprimerArticle(index) {
  if (!confirm('Voulez-vous vraiment supprimer cet article ?')) return;
  articles.splice(index, 1);
  fetch('/save-articles', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(articles),
    credentials: 'include'
  })
  .then(res => {
    if (res.ok) {
      alert('Article supprim√©');
      afficherArticles();
    } else {
      alert('Erreur lors de la suppression');
    }
  });
}

form.addEventListener('submit', e => {
  e.preventDefault();

  const nom = form.nom.value.trim();
  const prix = parseFloat(form.prix.value);
  const description = form.description.value.trim();
  const categorie = form.categorie.value;
  const tailles = Array.from(taillesOptions.querySelectorAll('input[type=checkbox]:checked'))
                      .map(i => i.value);

  if (!nom || !prix || !categorie) {
    alert('Merci de remplir les champs obligatoires');
    return;
  }

  // On va g√©rer l'image
  const fileInput = form.image;
  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function() {
      enregistrerArticle(nom, prix, description, categorie, tailles, reader.result);
    };
    reader.readAsDataURL(file);
  } else {
    // Pas de nouvelle image, on garde l'ancienne si on modifie
    let image = '';
    if (editingIndex !== null && articles[editingIndex]) {
      image = articles[editingIndex].image || '';
    }
    enregistrerArticle(nom, prix, description, categorie, tailles, image);
  }
});

function enregistrerArticle(nom, prix, description, categorie, tailles, image) {
  const article = { nom, prix, description, categorie, tailles, image };
  if (editingIndex !== null) {
    articles[editingIndex] = article;
  } else {
    articles.push(article);
  }

  fetch('/save-articles', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(articles),
    credentials: 'include'
  })
  .then(res => {
    if (res.ok) {
      alert(editingIndex !== null ? 'Article modifi√©' : 'Article ajout√©');
      editingIndex = null;
      form.reset();
      taillesContainer.style.display = 'none';
      toggleSection('liste');
      afficherArticles();
    } else {
      alert('Erreur lors de la sauvegarde');
    }
  });
}

// G√©n√©ration description IA (exemple simple)
document.getElementById('btn-description').addEventListener('click', () => {
  const nom = form.nom.value.trim();
  if (!nom) {
    alert('Merci de saisir le nom du produit avant');
    return;
  }
  document.getElementById('btn-description').disabled = true;
  document.getElementById('btn-description').textContent = 'G√©n√©ration en cours...';

  // Simuler appel API
  setTimeout(() => {
    form.description.value = `Description automatique d√©taill√©e pour ${nom}. C'est un produit exceptionnel de haute qualit√©.`;
    document.getElementById('btn-description').disabled = false;
    document.getElementById('btn-description').textContent = '‚ú® G√©n√©rer une description automatique (d√©taill√©e)';
  }, 2000);
});

document.getElementById('btn-ajout').addEventListener('click', () => {
  editingIndex = null;
  form.reset();
  taillesContainer.style.display = 'none';
  document.getElementById('form-title').textContent = 'Ajouter un article';
  toggleSection('ajout');
});

document.getElementById('btn-liste').addEventListener('click', () => {
  toggleSection('liste');
  afficherArticles();
});

// Sidebar fond
const sidebar = document.getElementById('sidebar');
document.getElementById('openSidebarBtn').addEventListener('click', () => {
  sidebar.classList.toggle('active');
});

document.getElementById('fond-blanc').addEventListener('click', () => {
  document.body.style.background = '#fff';
});
document.getElementById('fond-noir').addEventListener('click', () => {
  document.body.style.background = '#111';
});
document.getElementById('fond-gris').addEventListener('click', () => {
  document.body.style.background = '#eee';
});

document.getElementById('upload-fond').addEventListener('click', () => {
  const fileInput = document.getElementById('fond-file');
  if (fileInput.files.length === 0) {
    alert('Veuillez s√©lectionner une image');
    return;
  }
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    document.body.style.background = `url(${reader.result}) no-repeat center center fixed`;
    document.body.style.backgroundSize = 'cover';
  };
  reader.readAsDataURL(file);
});

// Logout
document.getElementById('logout-btn').addEventListener('click', () => {
  fetch('/logout', { method: 'POST', credentials: 'include' })
    .then(res => {
      if (res.ok) window.location.href = '/login.html';
    });
});

// Initial load
afficherArticles();
toggleSection('welcome');
</script>

</body>
</html>
