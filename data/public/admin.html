<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - PIPOU Store</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    header {
      background: #111;
      color: white;
      padding: 30px;
      text-align: center;
      font-size: 1.5em;
    }
    #welcome {
      text-align: center;
      padding: 60px 20px;
      font-size: 1.8em;
      color: #444;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .controls button {
      padding: 12px 20px;
      background: #222;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .controls button:hover {
      background: #444;
    }
    section {
      display: none;
      max-width: 800px;
      margin: auto;
    }
    section.active {
      display: block;
    }
    form, .article {
      background: white;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    form input, form select, form textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    form button {
      background: #111;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
    }
    .description-ia {
      text-align: left;
      font-size: 0.9em;
      color: #666;
      margin-bottom: 8px;
    }
    .description-ia button {
      background: #ffc107;
      color: #111;
      padding: 5px 10px;
      font-size: 0.9em;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .taille-bouton {
      display: inline-block;
      margin: 6px;
      padding: 10px 16px;
      background: #eee;
      border-radius: 20px;
      cursor: pointer;
      border: 1px solid #ccc;
      user-select: none;
      font-weight: bold;
      transition: all 0.2s ease-in-out;
    }
    .taille-bouton:hover {
      background: #ddd;
    }
    .taille-bouton input {
      display: none;
    }
    .taille-bouton input:checked + span,
    .taille-bouton input:checked {
      background-color: #222;
      color: white;
    }

    #openSidebarBtn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 12px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 1000;
    }
    #sidebar {
      position: fixed;
      left: -300px;
      top: 0;
      width: 300px;
      height: 100%;
      background: #f9f9f9;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      padding: 20px;
      transition: left 0.3s ease;
      z-index: 1000;
    }
    #sidebar.active {
      left: 0;
    }
    #logout-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: crimson;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 1000;
    }

    #liste-articles {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: flex-start;
    }
    .article {
      flex: 1 1 250px;
      max-width: 250px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

<header>Bienvenue sur l‚Äôadministration de PIPOU-Store</header>
<div id="welcome">Bienvenue ! Choisis une action ci-dessous üëá</div>

<div class="controls">
  <button id="btn-ajout">‚ûï Ajouter un article</button>
  <button id="btn-liste">üì¶ Voir les articles</button>
</div>

<section id="section-ajout">
  <form id="article-form">
    <h2 id="form-title">Ajouter un article</h2>
    <input type="text" id="nom" placeholder="Nom du produit" required />
    <input type="number" id="prix" placeholder="Prix (‚Ç¨)" step="0.01" required />
    <div class="description-ia">
      <button type="button" id="btn-description">‚ú® G√©n√©rer une description automatique (d√©taill√©e)</button>
    </div>
    <textarea id="description" placeholder="Description"></textarea>
    <input type="file" id="image" accept="image/*" />
    <select id="categorie" required>
      <option value="">-- S√©lectionner une cat√©gorie --</option>
      <option value="sacoches">sacoches</option>
      <option value="ceintures">ceintures</option>
      <option value="couvre-chef">couvre-chef</option>
      <option value="porte-feuille">porte-feuille</option>
      <option value="t-shirts">t-shirts</option>
      <option value="maillots">maillots</option>
      <option value="chemise">chemise</option>
      <option value="vestes/manteaux">vestes/manteaux</option>
      <option value="pantalon">pantalon</option>
      <option value="short">short</option>
      <option value="ensembles">ensembles</option>
      <option value="basket">basket</option>
      <option value="sabots">sabots</option>
      <option value="sneackers">sneackers</option>
      <option value="divers">divers</option>
      <option value="sweat">sweat</option>
      <option value="sweat-√†-capuche">sweat √† capuche</option>
      <option value="pull">pull</option>
    </select>
    <div id="tailles-container" style="display:none;">
      <label><strong>Tailles disponibles :</strong></label>
      <div id="tailles-options"></div>
    </div>
    <button type="submit" id="submit-btn">Ajouter</button>
  </form>
</section>

<section id="section-liste">
  <h2>Articles enregistr√©s</h2>
  <div id="liste-articles"></div>
</section>

<button id="openSidebarBtn">üé® Fond</button>
<div id="sidebar">
  <h3>Changer le fond</h3>
  <button id="fond-blanc">Blanc</button>
  <button id="fond-noir">Noir</button>
  <button id="fond-gris">Gris clair</button>
  <hr>
  <p><strong>Image personnalis√©e :</strong></p>
  <input type="file" id="fond-file" accept="image/*">
  <button id="upload-fond">Envoyer l'image</button>
</div>
<button id="logout-btn">D√©connexion</button>

<script>
// Session check
fetch('/check-session', { credentials: 'include' })
  .then(res => {
    if (!res.ok) window.location.href = '/login.html';
  });

// JavaScript principal ici (inchang√©, tu peux coller celui que tu avais d√©j√†)

const toutesTaillesChaussures = [38, 39, 40, 41, 42, 43, 44, 45];
const toutesTaillesVetements = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];

const form = document.getElementById('article-form');
const taillesContainer = document.getElementById('tailles-container');
const taillesOptions = document.getElementById('tailles-options');
const categorieSelect = document.getElementById('categorie');
const liste = document.getElementById('liste-articles');
let editingIndex = null;
let articles = [];

function toggleSection(id) {
  document.getElementById('section-ajout').classList.remove('active');
  document.getElementById('section-liste').classList.remove('active');
  document.getElementById('welcome').style.display = 'none';
  document.getElementById(`section-${id}`).classList.add('active');
}

function afficherTaillesSiBesoin() {
  const cat = categorieSelect.value;
  let tailles = [];

  if (['sneackers', 'basket', 'sabots'].includes(cat)) {
    tailles = toutesTaillesChaussures;
  } else if (['t-shirts', 'maillots', 'vestes/manteaux', 'pantalon', 'short'].includes(cat)) {
    tailles = toutesTaillesVetements;
  }

  if (tailles.length) {
    taillesContainer.style.display = "block";
    taillesOptions.innerHTML = tailles.map(t => `
      <label class="taille-bouton">
        <input type="checkbox" value="${t}"> <span>${t}</span>
      </label>
    `).join('');
  } else {
    taillesContainer.style.display = "none";
    taillesOptions.innerHTML = '';
  }
}

categorieSelect.addEventListener('change', afficherTaillesSiBesoin);

function afficherArticles() {
  fetch('/articles.json', { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      articles = data;
      // Inverse l'ordre pour afficher le dernier article en premier
      liste.innerHTML = articles.slice().reverse().map((a, i) => `
        <div class="article">
          <img src="${a.image}" alt="${a.nom}" style="max-width:100%;height:auto;">
          <h3>${a.nom}</h3>
          <p><strong>${a.prix} ‚Ç¨</strong></p>
          <p>${a.description}</p>
          <p>Cat√©gorie : ${a.categorie}</p>
          <p>${a.tailles ? `Tailles : ${a.tailles.join(', ')}` : ''}</p>
          <button onclick="modifierArticle(${articles.length - 1 - i})">‚úèÔ∏è Modifier</button>
          <button onclick="supprimerArticle(${articles.length - 1 - i})">‚ùå Supprimer</button>
        </div>
      `).join('');
    });
}

function modifierArticle(index) {
  editingIndex = index;
  const a = articles[index];
  toggleSection('ajout');
  document.getElementById('form-title').textContent = 'Modifier un article';
  form.nom.value = a.nom;
  form.prix.value = a.prix;
  form.description.value = a.description;
  form.categorie.value = a.categorie;
  afficherTaillesSiBesoin();

  // cocher les tailles existantes
  const checkboxes = taillesOptions.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = a.tailles?.includes(cb.value));
}

function supprimerArticle(index) {
  if (!confirm('Confirmer la suppression ?')) return;
  fetch(`/articles/${articles[index].id}`, {
    method: 'DELETE',
    credentials: 'include',
  })
  .then(res => {
    if (res.ok) {
      alert('Article supprim√©');
      afficherArticles();
    } else {
      alert('Erreur lors de la suppression');
    }
  });
}

form.addEventListener('submit', e => {
  e.preventDefault();

  const nom = form.nom.value.trim();
  const prix = parseFloat(form.prix.value);
  const description = form.description.value.trim();
  const categorie = form.categorie.value;
  const tailles = Array.from(taillesOptions.querySelectorAll('input[type="checkbox"]:checked'))
                      .map(cb => cb.value);

  if (!nom || isNaN(prix) || !categorie) {
    alert('Veuillez remplir les champs obligatoires');
    return;
  }

  const formData = new FormData();
  formData.append('nom', nom);
  formData.append('prix', prix);
  formData.append('description', description);
  formData.append('categorie', categorie);
  tailles.forEach(t => formData.append('tailles[]', t));

  const imageFile = form.image.files[0];
  if (imageFile) formData.append('image', imageFile);

  let url = '/articles';
  let method = 'POST';
  if (editingIndex !== null) {
    url = `/articles/${articles[editingIndex].id}`;
    method = 'PUT';
  }

  fetch(url, {
    method,
    credentials: 'include',
    body: formData
  })
  .then(res => {
    if (res.ok) {
      alert(editingIndex === null ? 'Article ajout√©' : 'Article modifi√©');
      form.reset();
      editingIndex = null;
      toggleSection('liste');
      afficherArticles();
    } else {
      alert('Erreur lors de l‚Äôenregistrement');
    }
  });
});

function genererDescriptionIA() {
  const nom = form.nom.value.trim();
  if (!nom) {
    alert('Entrez d‚Äôabord un nom de produit');
    return;
  }
  fetch(`/generate-description?nom=${encodeURIComponent(nom)}`, { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      form.description.value = data.description || 'Pas de description g√©n√©r√©e';
    });
}

function envoyerFond(couleur) {
  fetch('/fond', {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ couleur })
  })
  .then(res => {
    if (res.ok) {
      document.body.style.background = couleur;
      alert('Fond chang√© !');
    }
  });
}

document.getElementById('openSidebarBtn').addEventListener('click', () => {
  document.getElementById('sidebar').classList.toggle('active');
});

function uploadFond() {
  const fileInput = document.getElementById('fond-file');
  const file = fileInput.files[0];
  if (!file) {
    alert('Choisissez un fichier');
    return;
  }
  const fd = new FormData();
  fd.append('fond', file);

  fetch('/upload-fond', {
    method: 'POST',
    credentials: 'include',
    body: fd
  })
  .then(res => {
    if (res.ok) {
      alert('Fond personnalis√© envoy√© !');
      fileInput.value = '';
    } else {
      alert('Erreur lors de l‚Äôenvoi');
    }
  });
}

document.getElementById('logout-btn').addEventListener('click', () => {
  fetch('/logout', { method: 'POST', credentials: 'include' })
    .then(res => {
      if (res.ok) window.location.href = '/login.html';
    });
});

// Au chargement, afficher la liste des articles
afficherArticles();
toggleSection('liste');

// Ajouter les event listeners manquants (sans onclick inline)
document.getElementById('btn-ajout').addEventListener('click', () => toggleSection('ajout'));
document.getElementById('btn-liste').addEventListener('click', () => toggleSection('liste'));
document.getElementById('btn-description').addEventListener('click', genererDescriptionIA);
document.getElementById('fond-blanc').addEventListener('click', () => envoyerFond('#ffffff'));
document.getElementById('fond-noir').addEventListener('click', () => envoyerFond('#111111'));
document.getElementById('fond-gris').addEventListener('click', () => envoyerFond('#f2f2f2'));
document.getElementById('upload-fond').addEventListener('click', uploadFond);
document.getElementById('openSidebarBtn').addEventListener('click', () => {
  document.getElementById('sidebar').classList.toggle('active');
});
document.getElementById('logout-btn').addEventListener('click', () => {
  fetch('/logout', { method: 'POST', credentials: 'include' })
    .then(res => {
      if (res.ok) window.location.href = '/login.html';
    });
});
</script>

</body>
</html>
